<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Gestion Reportes</title>
    <link
      rel="stylesheet"
      href="../../CSS/reportes_gestion/usuarios_gestion_M6.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      rel="icon"
      type="image/png"
      href="../../CSS/auth/images/logo_ucv_modal.png"
    />
  </head>
  <body>
    <div class="sidebar">
      <div class="logo">
        <img src="../../CSS/auth/images/logo_ucv.png" alt="logoUcv" />
      </div>
      <ul>
        <li class="active">
          <a href="/usuarios_gestion"
            ><i class="fas fa-users"></i> Gestion de Usuarios</a
          >
        </li>
        <li>
          <a href="/reportes_gestion"
            ><i class="fas fa-chart-bar"></i> Gestion de Reportes</a
          >
        </li>
        <li>
          <a href="/existencia_entrada"
            ><i class="fas fa-file-import"></i> Existencia de Entrada</a
          >
        </li>
        <li>
          <a href="/existencia_salida"
            ><i class="fas fa-file-export"></i> Existencia de Salida</a
          >
        </li>
        <li>
          <a href="/productos_danados"
            ><i class="fas fa-exclamation-triangle"></i> Productos Dañados</a
          >
        </li>
        <li>
          <a href="articulos_uso_actual.html"
            ><i class="fas fa-cogs"></i> Artículos Uso Actual</a
          >
        </li>
        <li>
          <a href="/"><i class="fas fa-sign-out-alt"></i> Exit</a>
        </li>
      </ul>
    </div>

    <div class="main-content">
      <div class="header">
        <div class="header-logo"></div>
        <h1>Gestión de Usuarios</h1>
      </div>
      <div class="search-bar">
        <label>Buscar Usuario:</label>
        <div class="search-controls">
          <select>
            <option>Ordenar por Rol</option>
          </select>
          <input type="text" placeholder="Buscar por apellidos..." />
          <button class="disabled-btn" onclick="abrirModalDeshabilitados()">
            <i class="fas fa-ban"></i> Usuarios Deshabilitados
          </button>
        </div>
      </div>
      <div class="table-container">
        <div class="usuarios-box">
          <table class="usuarios-table">
            <thead>
              <tr>
                <th><span class="icon"></span> Usuario</th>
                <th><span class="icon"></span> Apellidos</th>
                <th><span class="icon"></span> Rol</th>
                <th><span class="icon"></span> Contraseña</th>
                <th><span class="icon"></span> Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="modalDeshabilitados" class="modal">
        <div class="modal-content">
          <span class="close" onclick="cerrarModalDeshabilitados()"
            >&times;</span
          >
          <h2>Usuarios Deshabilitados</h2>
          <table class="usuarios-table">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Apellidos</th>
                <th>Rol</th>
                <th>Contraseña</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="modalEditActual" class="modal">
        <div class="modal-content-edit">
          <span class="close">&times;</span>
          <div class="icono-container-modal">
            <img
              class="icono-btn-modal"
              src="../../CSS/auth/images/logo_ucv_modal.png"
              alt="report_LOGO-ucv"
            />
          </div>
          <h2>Editar Usuario</h2>
          <div class="form-group-edit">
            <label for="userName">Usuario:</label>
            <input type="text" id="userName" name="userName" />
          </div>
          <div class="form-group-edit">
            <label for="apellidosUser">Apellidos:</label>
            <input type="text" id="apellidosUser" name="apellidosUser" />
          </div>
          <div class="form-group-edit">
            <label for="roleUser">Artículo:</label>
            <select id="roleUser" name="roleUser">
              <option value="">Seleccione un artículo</option>
              <option value="Alumno">Alumno</option>
              <option value="Docente">Docente</option>
              <option value="Asistente">Asistente</option>
              <option value="Administrador">Administrador</option>
            </select>
          </div>
          <div class="form-group-edit">
            <label for="passwordUser">Contraseña:</label>
            <input type="text" id="passwordUser" name="passwordUser" />
          </div>
          <div class="form-actions-editar">
            <button type="submit" class="btn guardar-edit">
              <i class="fas fa-save"></i> Guardar Cambios
            </button>
          </div>
        </div>
      </div>

      <div id="modalDeshabilitar" class="modal">
        <div class="modal-content-deshabilitar">
          <span class="closeBtnDeshabilitar">&times;</span>
          <div class="icono-container-modal">
            <img
              class="icono-btn-modal"
              src="../../CSS/auth/images/logo_ucv_modal.png"
              alt="report_LOGO-ucv"
            />
          </div>
          <label
            >¿Estás seguro de que deseas deshabilitar a este usuario?</label
          >
          <div class="modal-actions-deshabiltar">
            <button class="btn aceptar">Aceptar</button>
            <button class="btn cancelar">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const API_URL = "https://ucv-reports-backend.onrender.com/usuarios";
        const CARGOS_URL = "https://ucv-reports-backend.onrender.com/cargos";
        let usuarios = [];
        let cargos = [];
        let editandoId = null;
        let idUsuarioDeshabilitar = null;

        const modalEditar = document.getElementById("modalEditActual");
        const closeBtn = modalEditar.querySelector(".close");

        const modalDeshabilitar = document.getElementById("modalDeshabilitar");
        const closeBtnDeshabilitar = modalDeshabilitar.querySelector(
          ".closeBtnDeshabilitar"
        );

        // MODAL EDITAR USUARIO
        closeBtn.addEventListener("click", () => {
          modalEditar.style.display = "none";
        });

        // MODAL DESHABILITAR USUARIO
        closeBtnDeshabilitar.addEventListener("click", () => {
          modalDeshabilitar.style.display = "none";
        });

        window.addEventListener("click", function (event) {
          if (event.target === modalEditar) {
            modalEditar.style.display = "none";
          }

          if (event.target === modalDeshabilitar) {
            modalDeshabilitar.style.display = "none";
          }
        });

        // Cargar usuarios y cargos
        async function cargarUsuarios() {
          try {
            const token = localStorage.getItem("access_token"); // Changed from 'token' to 'access_token'
            console.log(
              "Token retrieved from localStorage in cargarUsuarios:",
              token
            );
            const headers = { Authorization: `Bearer ${token}` };
            console.log("Headers sent in cargarUsuarios:", headers);

            const [usuariosRes, cargosRes] = await Promise.all([
              fetch(`${API_URL}?_relations=cargo`, { headers }),
              fetch(CARGOS_URL, { headers }),
            ]);
            console.log("Response from usuarios API:", usuariosRes);
            console.log("Response from cargos API:", cargosRes);

            if (!usuariosRes.ok) {
              const errorText = await usuariosRes.text();
              throw new Error(
                `HTTP error! status: ${usuariosRes.status}, message: ${errorText}`
              );
            }
            if (!cargosRes.ok) {
              const errorText = await cargosRes.text();
              throw new Error(
                `HTTP error! status: ${cargosRes.status}, message: ${errorText}`
              );
            }

            usuarios = (await usuariosRes.json()).filter(
              (u) => u.Estado === "Habilitado"
            );
            cargos = await cargosRes.json();
            console.log("Usuarios loaded:", usuarios);
            console.log("Cargos loaded:", cargos);

            renderUsuarios();
          } catch (error) {
            console.error("Error al cargar usuarios o cargos:", error);
            usuarios = [];
            cargos = [];
            renderUsuarios(); // Render with empty data on error
          }
        }

        function renderUsuarios() {
          const tbody = document.querySelector(".usuarios-table tbody");
          tbody.innerHTML = "";
          usuarios.forEach((usuario) => {
            const nombreCompleto =
              `${usuario.nombre} ${usuario.apellido_paterno} ${usuario.apellido_materno}`.trim();
            const rol =
              usuario.cargo && usuario.cargo.descripcion
                ? usuario.cargo.descripcion
                : "Sin Rol";
            const estaEditando = editandoId === usuario.IDUsuario;
            const tr = document.createElement("tr");
            if (estaEditando) {
              tr.innerHTML = `
                    <td><input type="text" value="${
                      usuario.usuario
                    }" id="editUsuario"></td>
                    <td>
                      <input type="text" value="${
                        usuario.apellido_paterno
                      }" id="editApellidoPaterno" style="width:45%">
                      <input type="text" value="${
                        usuario.apellido_materno
                      }" id="editApellidoMaterno" style="width:45%">
                    </td>
                    <td>
                      <select id="editRol">
                        ${cargos
                          .map(
                            (c) =>
                              `<option value="${c.idcargo}" ${
                                usuario.id_cargo === c.idcargo ? "selected" : ""
                              }>${c.descripcion}</option>`
                          )
                          .join("")}
                      </select>
                    </td>
                    <td><input type="password" value="" placeholder="Nueva contraseña" id="editContrasena"></td>
                    <td>
                      <button class="btn editar" onclick="guardarEdicion(${
                        usuario.IDUsuario
                      })"><i class="fas fa-save"></i> GUARDAR</button>
                      <button class="btn cancelar" onclick="cancelarEdicion()"><i class="fas fa-times"></i> CANCELAR</button>
                    </td>
                  `;
            } else {
              tr.innerHTML = `
                    <td>${usuario.usuario}</td>
                    <td>${nombreCompleto}</td>
                    <td>${rol}</td>
                    <td>**********</td>
                    <td>
                      <button class="btn editar" data-id="${usuario.IDUsuario}"><i class="fas fa-edit"></i> EDITAR</button>
                      <button class="btn deshabilitar" data-id="${usuario.IDUsuario}"><i class="fas fa-ban"></i> DESHABILITAR</button>
                    </td>
                  `;
            }
            tbody.appendChild(tr);
          });
        }

        function editarUsuario(id) {
          editandoId = id;
          renderUsuarios();
        }

        function cancelarEdicion() {
          editandoId = null;
          renderUsuarios();
        }

        async function guardarEdicion(id) {
          const usuario = document.getElementById("editUsuario").value.trim();
          const apellido_paterno = document
            .getElementById("editApellidoPaterno")
            .value.trim();
          const apellido_materno = document
            .getElementById("editApellidoMaterno")
            .value.trim();
          const id_cargo = parseInt(
            document.getElementById("editRol").value,
            10
          );
          const contrasena = document
            .getElementById("editContrasena")
            .value.trim();

          const body = {
            usuario,
            apellido_paterno,
            apellido_materno,
            id_cargo,
          };
          if (contrasena) body.contraseña = contrasena;

          try {
            const token = localStorage.getItem("access_token"); // Changed from 'token' to 'access_token'
            console.log(
              "Token retrieved from localStorage in guardarEdicion:",
              token
            );
            const headers = {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            };
            console.log("Headers sent in guardarEdicion:", headers);

            const response = await fetch(`${API_URL}/${id}`, {
              method: "PATCH",
              headers: headers,
              body: JSON.stringify(body),
            });
            console.log("Response from update API:", response);
            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(
                `HTTP error! status: ${response.status}, message: ${errorText}`
              );
            }
            editandoId = null;
            cargarUsuarios();
          } catch (error) {
            console.error("Error al guardar edición:", error);
            alert("Error al guardar edición. Por favor, inténtalo de nuevo.");
          }
        }

        async function deshabilitarUsuario(id) {
          idUsuarioDeshabilitar = id;
          modalDeshabilitar.style.display = "block";
        }

        // MODAL USUARIOS DESHABILITADOS
        async function cargarUsuariosDeshabilitados() {
          try {
            const token = localStorage.getItem("access_token"); // Changed from 'token' to 'access_token'
            console.log(
              "Token retrieved from localStorage in cargarUsuariosDeshabilitados:",
              token
            );
            const headers = { Authorization: `Bearer ${token}` };
            console.log(
              "Headers sent in cargarUsuariosDeshabilitados:",
              headers
            );

            const response = await fetch(API_URL, { headers });
            console.log("Response from disabled users API:", response);
            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(
                `HTTP error! status: ${response.status}, message: ${errorText}`
              );
            }
            const data = await response.json();
            console.log("Disabled users data:", data);
            const usuariosDeshabilitados = data.filter(
              (u) => u.Estado === "Deshabilitado"
            );
            renderUsuariosDeshabilitados(usuariosDeshabilitados);
          } catch (error) {
            console.error("Error al cargar usuarios deshabilitados:", error);
            renderUsuariosDeshabilitados([]); // Render with empty data on error
          }
        }

        function renderUsuariosDeshabilitados(usuariosDeshabilitados) {
          const tbody = document.querySelector(
            "#modalDeshabilitados .usuarios-table tbody"
          );
          tbody.innerHTML = "";
          usuariosDeshabilitados.forEach((usuario) => {
            const nombreCompleto =
              `${usuario.nombre} ${usuario.apellido_paterno} ${usuario.apellido_materno}`.trim();
            const rol =
              usuario.cargo && usuario.cargo.descripcion
                ? usuario.cargo.descripcion
                : "Sin Rol";
            const tr = document.createElement("tr");
            tr.innerHTML = `
                  <td>${usuario.usuario}</td>
                  <td>${nombreCompleto}</td>
                  <td>${rol}</td>
                  <td>**********</td>
                  <td>
                    <button class="btn reactivar" onclick="reactivarUsuario(${usuario.IDUsuario})">
                      <span class="icon">✏️</span> Reactivar
                    </button>
                  </td>
                `;
            tbody.appendChild(tr);
          });
        }

        function abrirModalDeshabilitados() {
          cargarUsuariosDeshabilitados();
          document.getElementById("modalDeshabilitados").style.display =
            "block";
        }

        function cerrarModalDeshabilitados() {
          document.getElementById("modalDeshabilitados").style.display = "none";
        }

        async function reactivarUsuario(id) {
          try {
            const token = localStorage.getItem("access_token"); // Changed from 'token' to 'access_token'
            console.log(
              "Token retrieved from localStorage in reactivarUsuario:",
              token
            );
            const headers = {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            };
            console.log("Headers sent in reactivarUsuario:", headers);

            const response = await fetch(`${API_URL}/${id}`, {
              method: "PATCH",
              headers: headers,
              body: JSON.stringify({ Estado: "Habilitado" }),
            });
            console.log("Response from reactivate API:", response);
            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(
                `HTTP error! status: ${response.status}, message: ${errorText}`
              );
            }
            cargarUsuariosDeshabilitados();
            cargarUsuarios();
          } catch (error) {
            console.error("Error al reactivar usuario:", error);
            alert("Error al reactivar usuario. Por favor, inténtalo de nuevo.");
          }
        }

        document.addEventListener("DOMContentLoaded", () => {
          cargarUsuarios();

          document
            .querySelector(".usuarios-table tbody")
            .addEventListener("click", (event) => {
              const target = event.target.closest("button");
              if (!target) return;

              const id = parseInt(target.dataset.id);

              if (target.classList.contains("editar")) {
                editarUsuario(id);
              } else if (target.classList.contains("deshabilitar")) {
                deshabilitarUsuario(id);
              }
            });

          document
            .querySelector("#modalDeshabilitar .btn.aceptar")
            .addEventListener("click", async () => {
              try {
                const token = localStorage.getItem("access_token"); // Changed from 'token' to 'access_token'
                console.log(
                  "Token retrieved from localStorage in deshabilitarUsuario (aceptar):",
                  token
                );
                const headers = {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                };
                console.log(
                  "Headers sent in deshabilitarUsuario (aceptar):",
                  headers
                );

                const response = await fetch(
                  `${API_URL}/${idUsuarioDeshabilitar}`,
                  {
                    method: "PATCH",
                    headers: headers,
                    body: JSON.stringify({ Estado: "Deshabilitado" }),
                  }
                );
                console.log("Response from disable API:", response);
                if (!response.ok) {
                  const errorText = await response.text();
                  throw new Error(
                    `HTTP error! status: ${response.status}, message: ${errorText}`
                  );
                }
                modalDeshabilitar.style.display = "none";
                cargarUsuarios();
              } catch (error) {
                console.error("Error al deshabilitar usuario:", error);
                alert(
                  "Error al deshabilitar usuario. Por favor, inténtalo de nuevo."
                );
              }
            });

          document
            .querySelector("#modalDeshabilitar .btn.cancelar")
            .addEventListener("click", () => {
              modalDeshabilitar.style.display = "none";
            });
        });
      });
    </script>
  </body>
</html>
